<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Technical PhDs Per Capita by Metro</title>
<style>
  @font-face {
    font-family: 'ABC Oracle';
    src: url('/Users/azizsunderji/Dropbox/Home Economics/Brand Assets/OracleFont/Oracle Aziz Sunderji/Desktop/ABCOracle-Regular.otf') format('opentype');
    font-weight: 400;
  }
  @font-face {
    font-family: 'ABC Oracle';
    src: url('/Users/azizsunderji/Dropbox/Home Economics/Brand Assets/OracleFont/Oracle Aziz Sunderji/Desktop/ABCOracle-Bold.otf') format('opentype');
    font-weight: 700;
  }
  @font-face {
    font-family: 'ABC Oracle';
    src: url('/Users/azizsunderji/Dropbox/Home Economics/Brand Assets/OracleFont/Oracle Aziz Sunderji/Desktop/ABCOracle-Light.otf') format('opentype');
    font-weight: 300;
  }
  @font-face {
    font-family: 'ABC Oracle';
    src: url('/Users/azizsunderji/Dropbox/Home Economics/Brand Assets/OracleFont/Oracle Aziz Sunderji/Desktop/ABCOracle-Medium.otf') format('opentype');
    font-weight: 500;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #F6F7F3;
    font-family: 'ABC Oracle', -apple-system, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }
  #chart { position: relative; }
  #save-btn {
    position: fixed;
    top: 12px;
    right: 12px;
    background: #3D3733;
    color: #F6F7F3;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-family: 'ABC Oracle', sans-serif;
    font-size: 12px;
    cursor: pointer;
    z-index: 20;
  }
  #save-btn:hover { opacity: 0.8; }
  .tooltip {
    position: absolute;
    pointer-events: none;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 12px;
    font-family: 'ABC Oracle', sans-serif;
    color: #3D3733;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    opacity: 0;
    transition: opacity 0.15s;
    white-space: nowrap;
    z-index: 10;
  }
  .tooltip .name { font-weight: 700; font-size: 13px; margin-bottom: 3px; }
  .tooltip .stat { font-weight: 300; color: #666; }
  .tooltip .highlight { color: #0BB4FF; font-weight: 500; }
</style>
</head>
<body>
<button id="save-btn" onclick="saveSVG()">Save SVG</button>
<div id="chart">
  <div class="tooltip" id="tooltip"></div>
</div>
<script>
function saveSVG() {
  const svg = document.querySelector('#chart svg');
  const serializer = new XMLSerializer();
  let source = serializer.serializeToString(svg);
  source = '<?xml version="1.0" encoding="UTF-8"?>\n' + source;
  const blob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'phd_beeswarm.svg';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const WIDTH = 900, HEIGHT = 750;
const MARGIN = {top: 70, right: 30, bottom: 60, left: 30};
const w = WIDTH - MARGIN.left - MARGIN.right;
const h = HEIGHT - MARGIN.top - MARGIN.bottom;

const BLUE = '#0BB4FF';
const RED = '#F4743B';
const BLACK = '#3D3733';

const svg = d3.select('#chart')
  .append('svg')
  .attr('width', WIDTH)
  .attr('height', HEIGHT);

svg.append('rect')
  .attr('width', WIDTH)
  .attr('height', HEIGHT)
  .attr('fill', '#F6F7F3');

const g = svg.append('g')
  .attr('transform', `translate(${MARGIN.left},${MARGIN.top})`);

// Data — all metros with >0 PhDs and >50k pop
const metros = [
  {short: "Bay Area", phds: 44321, per10k: 93.5, pop: 6556620},
  {short: "Ithaca", phds: 817, per10k: 132.8, pop: 103706},
  {short: "State College", phds: 708, per10k: 72.5, pop: 157830},
  {short: "Ann Arbor", phds: 1347, per10k: 57.1, pop: 368495},
  {short: "Princeton", phds: 1402, per10k: 54.1, pop: 382880},
  {short: "Santa Cruz", phds: 896, per10k: 49.8, pop: 266565},
  {short: "Lawrence", phds: 344, per10k: 48.8, pop: 119791},
  {short: "Gainesville", phds: 779, per10k: 45.3, pop: 281423},
  {short: "Bloomington IN", phds: 375, per10k: 45.2, pop: 139851},
  {short: "College Station", phds: 557, per10k: 44.0, pop: 237618},
  {short: "Boston", phds: 15345, per10k: 43.5, pop: 4991280},
  {short: "Lafayette IN", phds: 433, per10k: 41.4, pop: 187292},
  {short: "Seattle", phds: 11460, per10k: 40.2, pop: 4021498},
  {short: "Santa Barbara", phds: 1107, per10k: 39.7, pop: 444935},
  {short: "Santa Fe", phds: 431, per10k: 39.1, pop: 144235},
  {short: "Iowa City", phds: 338, per10k: 36.8, pop: 154754},
  {short: "Washington DC", phds: 15640, per10k: 35.8, pop: 6364805},
  {short: "Albuquerque", phds: 2279, per10k: 34.8, pop: 929859},
  {short: "Corvallis", phds: 224, per10k: 33.0, pop: 106776},
  {short: "Blacksburg", phds: 369, per10k: 32.8, pop: 180826},
  {short: "E. Lansing", phds: 1001, per10k: 32.5, pop: 470255},
  {short: "Portland", phds: 4989, per10k: 28.6, pop: 2444214},
  {short: "San Diego", phds: 5993, per10k: 26.4, pop: 3283122},
  {short: "Austin", phds: 4165, per10k: 25.3, pop: 2400159},
  {short: "Knoxville", phds: 1493, per10k: 24.3, pop: 882060},
  {short: "Albany", phds: 1442, per10k: 23.7, pop: 873312},
  {short: "Baltimore", phds: 4519, per10k: 23.3, pop: 2789207},
  {short: "Worcester", phds: 1584, per10k: 23.2, pop: 970563},
  {short: "Raleigh", phds: 2200, per10k: 22.6, pop: 1437614},
  {short: "Bellingham", phds: 334, per10k: 21.5, pop: 228456},
  {short: "Mankato", phds: 130, per10k: 20.5, pop: 103809},
  {short: "Bloomington IL", phds: 215, per10k: 20.3, pop: 170942},
  {short: "Fort Collins", phds: 495, per10k: 20.3, pop: 363740},
  {short: "Bridgeport", phds: 1301, per10k: 19.9, pop: 947369},
  {short: "Las Cruces", phds: 268, per10k: 19.4, pop: 221736},
  {short: "Huntsville", phds: 649, per10k: 19.1, pop: 491970},
  {short: "New Haven", phds: 1104, per10k: 18.7, pop: 841793},
  {short: "Tucson", phds: 1288, per10k: 17.6, pop: 1061624},
  {short: "Pittsburgh", phds: 2908, per10k: 17.3, pop: 2298700},
  {short: "Rochester", phds: 1305, per10k: 17.3, pop: 1077815},
  {short: "Panama City", phds: 221, per10k: 16.8, pop: 183300},
  {short: "New York", phds: 23358, per10k: 16.2, pop: 20562983},
  {short: "Lubbock", phds: 306, per10k: 16.2, pop: 314479},
  {short: "Niles", phds: 176, per10k: 16.3, pop: 153323},
  {short: "Lincoln", phds: 299, per10k: 14.7, pop: 323813},
  {short: "Flagstaff", phds: 122, per10k: 14.0, pop: 145008},
  {short: "Chicago", phds: 9117, per10k: 14.0, pop: 9478387},
  {short: "Bangor", phds: 134, per10k: 14.3, pop: 131476},
  {short: "Harrisonburg", phds: 111, per10k: 13.2, pop: 136010},
  {short: "Pittsfield", phds: 128, per10k: 13.4, pop: 128058},
  {short: "Hartford", phds: 1041, per10k: 13.1, pop: 1132576},
  {short: "Salt Lake City", phds: 1095, per10k: 13.0, pop: 1320898},
  {short: "Los Angeles", phds: 11723, per10k: 12.9, pop: 13011058},
  {short: "Denver", phds: 2689, per10k: 12.7, pop: 3010532},
  {short: "Colorado Springs", phds: 639, per10k: 12.6, pop: 760635},
  {short: "Yuba City", phds: 146, per10k: 12.4, pop: 182056},
  {short: "Charleston SC", phds: 706, per10k: 12.4, pop: 818071},
  {short: "Utica", phds: 225, per10k: 11.9, pop: 271662},
  {short: "Boise", phds: 654, per10k: 11.9, pop: 820487},
  {short: "Columbia SC", phds: 613, per10k: 11.8, pop: 786648},
  {short: "Houston", phds: 5494, per10k: 11.8, pop: 7156107},
  {short: "Philadelphia", phds: 5179, per10k: 11.8, pop: 6284816},
  {short: "Atlanta", phds: 4874, per10k: 11.8, pop: 6144525},
  {short: "Tuscaloosa", phds: 168, per10k: 11.6, pop: 234471},
  {short: "Dallas", phds: 5825, per10k: 11.5, pop: 7734594},
  {short: "Minneapolis", phds: 2877, per10k: 11.5, pop: 3656687},
  {short: "Springfield MA", phds: 443, per10k: 11.5, pop: 564835},
  {short: "Richmond", phds: 1043, per10k: 11.2, pop: 1330046},
  {short: "Cincinnati", phds: 1634, per10k: 11.1, pop: 2189635},
  {short: "Salinas", phds: 340, per10k: 10.5, pop: 501233},
  {short: "Palm Bay", phds: 492, per10k: 10.6, pop: 620472},
  {short: "Baton Rouge", phds: 574, per10k: 10.4, pop: 850410},
  {short: "Eugene", phds: 273, per10k: 10.2, pop: 382630},
  {short: "Fayetteville AR", phds: 350, per10k: 10.0, pop: 546827},
  {short: "Sacramento", phds: 1626, per10k: 9.9, pop: 2405927},
  {short: "Barnstable", phds: 207, per10k: 9.9, pop: 265117},
  {short: "San Luis Obispo", phds: 184, per10k: 9.7, pop: 282472},
  {short: "Phoenix", phds: 3273, per10k: 9.7, pop: 4929954},
  {short: "Nashville", phds: 1355, per10k: 9.6, pop: 2075681},
  {short: "Toledo", phds: 345, per10k: 9.6, pop: 537080},
  {short: "Akron", phds: 472, per10k: 9.6, pop: 699420},
  {short: "Honolulu", phds: 674, per10k: 9.5, pop: 1003612},
  {short: "Oxnard", phds: 542, per10k: 9.4, pop: 838268},
  {short: "Birmingham", phds: 709, per10k: 9.0, pop: 1158705},
  {short: "Providence", phds: 1065, per10k: 9.0, pop: 1672598},
  {short: "Reno", phds: 308, per10k: 8.9, pop: 491746},
  {short: "Detroit", phds: 2705, per10k: 8.7, pop: 4420960},
  {short: "Napa", phds: 85, per10k: 8.7, pop: 136233},
  {short: "Charlotte", phds: 1562, per10k: 8.3, pop: 2754405},
  {short: "Lawton", phds: 69, per10k: 8.3, pop: 128072},
  {short: "Allentown", phds: 492, per10k: 8.1, pop: 867285},
  {short: "Jackson TN", phds: 63, per10k: 8.1, pop: 116223},
  {short: "Yakima", phds: 125, per10k: 8.0, pop: 256185},
  {short: "Provo", phds: 276, per10k: 7.9, pop: 683262},
  {short: "Orlando", phds: 1449, per10k: 7.7, pop: 2721767},
  {short: "Medford", phds: 124, per10k: 7.7, pop: 222574},
  {short: "Stockton", phds: 383, per10k: 7.6, pop: 787626},
  {short: "Greeley", phds: 167, per10k: 7.5, pop: 341467},
  {short: "Waco", phds: 120, per10k: 7.4, pop: 263459},
  {short: "St. Louis", phds: 1478, per10k: 7.3, pop: 2895984},
  {short: "Memphis", phds: 587, per10k: 7.3, pop: 1215682},
  {short: "Greensboro", phds: 403, per10k: 7.2, pop: 824969},
  {short: "Louisville", phds: 645, per10k: 7.2, pop: 1292960},
  {short: "Buffalo", phds: 591, per10k: 7.2, pop: 1162227},
  {short: "Atlantic City", phds: 132, per10k: 7.1, pop: 264226},
  {short: "Oklahoma City", phds: 639, per10k: 7.1, pop: 1386040},
  {short: "Spokane", phds: 318, per10k: 7.0, pop: 655805},
  {short: "Wichita Falls", phds: 58, per10k: 6.9, pop: 130306},
  {short: "Lancaster", phds: 257, per10k: 6.8, pop: 555317},
  {short: "Santa Rosa", phds: 238, per10k: 6.7, pop: 485294},
  {short: "Grand Rapids", phds: 408, per10k: 6.5, pop: 957450},
  {short: "Lynchburg", phds: 115, per10k: 6.5, pop: 262169},
  {short: "San Antonio", phds: 1068, per10k: 6.4, pop: 2531462},
  {short: "Jackson MS", phds: 260, per10k: 6.3, pop: 614738},
  {short: "El Paso", phds: 340, per10k: 6.3, pop: 866830},
  {short: "Charleston WV", phds: 82, per10k: 6.3, pop: 178321},
  {short: "Bismarck", phds: 56, per10k: 6.2, pop: 132224},
  {short: "Fort Wayne", phds: 157, per10k: 6.2, pop: 388802},
  {short: "Monroe LA", phds: 64, per10k: 6.2, pop: 158534},
  {short: "Ogden", phds: 237, per10k: 6.1, pop: 633136},
  {short: "Amarillo", phds: 103, per10k: 6.1, pop: 260555},
  {short: "North Port", phds: 410, per10k: 6.1, pop: 864490},
  {short: "San Angelo", phds: 47, per10k: 6.0, pop: 119789},
  {short: "Burlington NC", phds: 70, per10k: 6.0, pop: 174026},
  {short: "Miami", phds: 2537, per10k: 5.8, pop: 6102902},
  {short: "Harrisburg", phds: 243, per10k: 5.8, pop: 597640},
  {short: "Greenville NC", phds: 62, per10k: 5.8, pop: 172368},
  {short: "Indianapolis", phds: 826, per10k: 5.8, pop: 2127695},
  {short: "Norwich", phds: 115, per10k: 5.8, pop: 277842},
  {short: "Wilmington NC", phds: 116, per10k: 5.6, pop: 294972},
  {short: "Crestview", phds: 133, per10k: 5.6, pop: 337585},
  {short: "Johnson City", phds: 91, per10k: 5.6, pop: 226963},
  {short: "Milwaukee", phds: 605, per10k: 5.6, pop: 1566695},
  {short: "Portland ME", phds: 222, per10k: 5.4, pop: 557893},
  {short: "Olympia", phds: 115, per10k: 5.4, pop: 296629},
  {short: "St. George", phds: 68, per10k: 5.4, pop: 189950},
  {short: "Pueblo", phds: 57, per10k: 5.2, pop: 156992},
  {short: "Kalamazoo", phds: 132, per10k: 5.2, pop: 389079},
  {short: "Lafayette LA", phds: 164, per10k: 5.1, pop: 480360},
  {short: "Fayetteville NC", phds: 104, per10k: 5.0, pop: 335883},
  {short: "Spartanburg", phds: 111, per10k: 4.9, pop: 337965},
  {short: "Midland", phds: 53, per10k: 4.9, pop: 171508},
  {short: "Little Rock", phds: 239, per10k: 4.7, pop: 753737},
  {short: "Myrtle Beach", phds: 169, per10k: 4.7, pop: 463259},
  {short: "Springfield OH", phds: 44, per10k: 4.7, pop: 135529},
  {short: "Greenville SC", phds: 318, per10k: 4.6, pop: 1012493},
  {short: "Salisbury", phds: 142, per10k: 4.6, pop: 429663},
  {short: "Chattanooga", phds: 179, per10k: 4.6, pop: 548748},
  {short: "Jacksonville", phds: 503, per10k: 4.5, pop: 1611064},
  {short: "Bremerton", phds: 88, per10k: 4.5, pop: 276811},
  {short: "Dover", phds: 56, per10k: 4.5, pop: 184880},
  {short: "Jonesboro", phds: 40, per10k: 4.5, pop: 135092},
  {short: "Wenatchee", phds: 37, per10k: 4.4, pop: 123112},
  {short: "Elkhart", phds: 57, per10k: 4.4, pop: 206886},
  {short: "Sumter", phds: 36, per10k: 4.4, pop: 121757},
  {short: "Omaha", phds: 304, per10k: 4.3, pop: 1058871},
  {short: "Scranton", phds: 154, per10k: 4.3, pop: 506449},
  {short: "Rockford", phds: 99, per10k: 4.3, pop: 336629},
  {short: "Anchorage", phds: 131, per10k: 4.3, pop: 459730},
  {short: "Johnstown", phds: 41, per10k: 4.3, pop: 132115},
  {short: "Montgomery", phds: 89, per10k: 3.0, pop: 431524},
  {short: "Riverside", phds: 1234, per10k: 4.1, pop: 4638966},
  {short: "Merced", phds: 70, per10k: 4.1, pop: 285920},
  {short: "Decatur", phds: 43, per10k: 4.0, pop: 156901},
  {short: "Roanoke", phds: 97, per10k: 4.0, pop: 335327},
  {short: "Des Moines", phds: 166, per10k: 4.0, pop: 618551},
  {short: "Chico", phds: 53, per10k: 3.9, pop: 209672},
  {short: "Gulfport", phds: 95, per10k: 3.9, pop: 354814},
  {short: "St. Cloud", phds: 51, per10k: 3.8, pop: 211394},
  {short: "Wichita", phds: 156, per10k: 3.8, pop: 626237},
  {short: "Mobile", phds: 106, per10k: 3.8, pop: 413144},
  {short: "Kansas City", phds: 575, per10k: 3.8, pop: 2256185},
  {short: "Vallejo", phds: 118, per10k: 3.8, pop: 450602},
  {short: "Tampa", phds: 860, per10k: 3.6, pop: 3239566},
  {short: "Las Vegas", phds: 577, per10k: 3.6, pop: 2293694},
  {short: "Tulsa", phds: 276, per10k: 3.6, pop: 1155561},
  {short: "Winston", phds: 169, per10k: 3.7, pop: 664893},
  {short: "Cape Coral", phds: 209, per10k: 3.5, pop: 792714},
  {short: "Bakersfield", phds: 194, per10k: 3.5, pop: 910561},
  {short: "Mount Vernon", phds: 33, per10k: 3.5, pop: 131031},
  {short: "Modesto", phds: 84, per10k: 2.4, pop: 551956},
  {short: "Asheville", phds: 132, per10k: 3.4, pop: 528577},
  {short: "York", phds: 108, per10k: 3.4, pop: 458992},
  {short: "Hickory", phds: 83, per10k: 2.8, pop: 411809},
  {short: "Pensacola", phds: 103, per10k: 2.9, pop: 518531},
  {short: "Hattiesburg", phds: 35, per10k: 3.0, pop: 178923},
  {short: "Glens Falls", phds: 30, per10k: 3.2, pop: 126403},
  {short: "Lima", phds: 22, per10k: 3.2, pop: 101753},
  {short: "Fresno", phds: 115, per10k: 1.8, pop: 1011642},
  {short: "Topeka", phds: 44, per10k: 2.4, pop: 266166},
  {short: "Deltona", phds: 126, per10k: 2.4, pop: 689761},
  {short: "Sebastian", phds: 31, per10k: 2.4, pop: 163945},
  {short: "Saginaw", phds: 30, per10k: 2.3, pop: 189130},
  {short: "Erie", phds: 42, per10k: 2.3, pop: 269914},
  {short: "Punta Gorda", phds: 37, per10k: 2.3, pop: 195020},
  {short: "Tyler", phds: 35, per10k: 2.2, pop: 237904},
  {short: "Gainesville GA", phds: 31, per10k: 2.2, pop: 208753},
  {short: "Canton", phds: 61, per10k: 2.2, pop: 400483},
  {short: "Springfield MO", phds: 64, per10k: 2.2, pop: 432133},
  {short: "Springfield IL", phds: 29, per10k: 2.1, pop: 194733},
  {short: "Brownsville", phds: 49, per10k: 1.9, pop: 423186},
  {short: "Port St. Lucie", phds: 71, per10k: 1.9, pop: 506948},
  {short: "Lakeland", phds: 94, per10k: 1.8, pop: 760922},
  {short: "Corpus Christi", phds: 57, per10k: 1.8, pop: 484613},
  {short: "Salem", phds: 57, per10k: 1.7, pop: 486675},
  {short: "Goldsboro", phds: 13, per10k: 1.7, pop: 117637},
  {short: "Laredo", phds: 25, per10k: 1.6, pop: 267699},
  {short: "Cleveland TN", phds: 13, per10k: 1.5, pop: 127203},
  {short: "Naples", phds: 44, per10k: 1.5, pop: 387561},
  {short: "Racine", phds: 21, per10k: 1.5, pop: 197021},
  {short: "Cheyenne", phds: 10, per10k: 1.5, pop: 101356},
  {short: "Yuma", phds: 21, per10k: 1.4, pop: 224246},
  {short: "Anniston", phds: 11, per10k: 1.4, pop: 116198},
  {short: "Warner Robins", phds: 17, per10k: 1.4, pop: 176846},
  {short: "Coeur d'Alene", phds: 16, per10k: 1.3, pop: 172296},
  {short: "Odessa", phds: 13, per10k: 1.3, pop: 163205},
  {short: "Reading", phds: 37, per10k: 1.3, pop: 430151},
  {short: "La Crosse", phds: 10, per10k: 1.3, pop: 120354},
  {short: "Ocala", phds: 33, per10k: 1.1, pop: 387997},
  {short: "Homosassa Springs", phds: 13, per10k: 1.0, pop: 158877},
  {short: "Grand Junction", phds: 10, per10k: 1.0, pop: 140546},
  {short: "Muncie", phds: 7, per10k: 1.0, pop: 112282},
  {short: "Beaumont", phds: 25, per10k: 0.9, pop: 396285},
  {short: "Visalia", phds: 24, per10k: 0.8, pop: 475680},
  {short: "McAllen", phds: 42, per10k: 0.8, pop: 880882},
  {short: "Janesville", phds: 8, per10k: 0.7, pop: 163787},
  {short: "Youngstown", phds: 25, per10k: 0.6, pop: 538298},
  {short: "East Stroudsburg", phds: 6, per10k: 0.5, pop: 167777},
  {short: "Clarksville", phds: 9, per10k: 0.4, pop: 336235},
  {short: "Shreveport", phds: 12, per10k: 0.4, pop: 398533},
  {short: "Dothan", phds: 3, per10k: 0.3, pop: 152376},
  {short: "Joplin", phds: 2, per10k: 0.2, pop: 183083},
  {short: "Albany OR", phds: 4, per10k: 0.5, pop: 119480}
];

// Scales
const xScale = d3.scaleLinear()
  .domain([0, 100])
  .range([0, w]);

const maxPhds = d3.max(metros, d => d.phds);
const rScale = d3.scaleSqrt()
  .domain([0, maxPhds])
  .range([2, 55]);

// Force simulation for beeswarm
const midY = h / 2;

metros.forEach(d => {
  d.x = xScale(d.per10k);
  d.y = midY;
  d.r = rScale(d.phds);
});

const simulation = d3.forceSimulation(metros)
  .force('x', d3.forceX(d => xScale(d.per10k)).strength(1))
  .force('y', d3.forceY(midY).strength(0.07))
  .force('collide', d3.forceCollide(d => d.r + 1.2).iterations(4))
  .stop();

// Run simulation
for (let i = 0; i < 300; i++) simulation.tick();

// Clamp y to stay within chart bounds
metros.forEach(d => {
  d.y = Math.max(d.r, Math.min(h - d.r, d.y));
});

// Gridlines
const xTicks = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
g.selectAll('.grid-x')
  .data(xTicks)
  .enter().append('line')
  .attr('x1', d => xScale(d)).attr('x2', d => xScale(d))
  .attr('y1', 0).attr('y2', h)
  .attr('stroke', '#DDDDD8').attr('stroke-width', 0.5);

// Tooltip
const tooltip = d3.select('#tooltip');

// Bubbles
g.selectAll('circle.bubble')
  .data(metros.sort((a, b) => b.phds - a.phds))
  .enter().append('circle')
  .attr('class', 'bubble')
  .attr('cx', d => d.x)
  .attr('cy', d => d.y)
  .attr('r', d => d.r)
  .attr('fill', BLUE)
  .attr('opacity', 0.55)
  .attr('stroke', 'none')
  .on('mouseover', function(event, d) {
    d3.select(this)
      .attr('opacity', 0.9)
      .attr('stroke', BLACK)
      .attr('stroke-width', 1.5);

    const fmtPop = d.pop >= 1e6 ? (d.pop / 1e6).toFixed(1) + 'M' : Math.round(d.pop / 1e3) + 'k';
    const fmtPhds = d.phds >= 1e3 ? (d.phds / 1e3).toFixed(1) + 'k' : d.phds.toLocaleString();

    tooltip.html(`
      <div class="name">${d.short}</div>
      <div class="stat">Population: ${fmtPop}</div>
      <div class="stat">Technical PhDs: <span class="highlight">${fmtPhds}</span></div>
      <div class="stat">Per 10k adults: <span class="highlight">${d.per10k}</span></div>
    `);
    tooltip.style('opacity', 1);
  })
  .on('mousemove', function(event) {
    const rect = document.getElementById('chart').getBoundingClientRect();
    tooltip
      .style('left', (event.clientX - rect.left + 15) + 'px')
      .style('top', (event.clientY - rect.top - 10) + 'px');
  })
  .on('mouseout', function() {
    d3.select(this)
      .attr('opacity', 0.55)
      .attr('stroke', 'none');
    tooltip.style('opacity', 0);
  });

// Labels for key metros
const labelMetros = [
  'Bay Area', 'Boston', 'Seattle', 'Washington DC',
  'Ann Arbor', 'Princeton', 'State College', 'Albuquerque',
  'Springfield MA'
];

const HIGHLIGHT_METRO = 'Springfield MA';
const labeled = metros.filter(d => labelMetros.includes(d.short));

// Highlight labeled dots with stroke
g.selectAll('circle.label-highlight')
  .data(labeled)
  .enter().append('circle')
  .attr('cx', d => d.x)
  .attr('cy', d => d.y)
  .attr('r', d => d.r)
  .attr('fill', d => d.short === HIGHLIGHT_METRO ? RED : BLUE)
  .attr('opacity', 0.85)
  .attr('stroke', BLACK)
  .attr('stroke-width', 1)
  .style('pointer-events', 'none');

// Label offsets — manually tuned for 9 labels
const offsets = {
  'Bay Area':       { dy: -1.3 },
  'Boston':         { dy: -1.3 },
  'Seattle':        { dy: 1.3 },
  'Washington DC':  { dy: -1.3 },
  'Albuquerque':    { dy: 1.3 },
  'Ann Arbor':      { dy: -1.3 },
  'Princeton':      { dy: 1.3 },
  'State College':  { dy: -1.3 },
  'Springfield MA': { dy: 1.3 },
};

// Leader lines and labels
labeled.forEach(d => {
  const off = offsets[d.short] || { dy: -1.3 };
  const labelY = d.y + (d.r + 12) * off.dy;

  g.append('line')
    .attr('x1', d.x)
    .attr('y1', d.y + d.r * Math.sign(off.dy))
    .attr('x2', d.x)
    .attr('y2', labelY)
    .attr('stroke', BLACK)
    .attr('stroke-width', 0.5)
    .attr('opacity', 0.35);

  g.append('text')
    .attr('x', d.x)
    .attr('y', labelY + (off.dy > 0 ? 13 : -5))
    .attr('text-anchor', 'middle')
    .style('font-family', 'ABC Oracle, sans-serif')
    .style('font-size', '10px')
    .style('font-weight', '500')
    .style('fill', d.short === HIGHLIGHT_METRO ? RED : BLACK)
    .text(d.short);
});

// X axis
const xAxis = d3.axisBottom(xScale)
  .tickValues([0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100])
  .tickFormat(d => d);

g.append('g')
  .attr('transform', `translate(0,${h})`)
  .call(xAxis)
  .call(g => g.select('.domain').attr('stroke', '#CCC'))
  .call(g => g.selectAll('.tick line').attr('stroke', '#CCC'))
  .call(g => g.selectAll('.tick text')
    .style('font-family', 'ABC Oracle, sans-serif')
    .style('font-size', '10px')
    .style('font-weight', '300')
    .style('fill', '#888'));

g.append('text')
  .attr('x', w / 2).attr('y', h + 45)
  .attr('text-anchor', 'middle')
  .style('font-family', 'ABC Oracle, sans-serif')
  .style('font-size', '12px')
  .style('font-weight', '500')
  .style('fill', BLACK)
  .text('Technical PhDs per 10,000 adults');

// Title
svg.append('text')
  .attr('x', WIDTH / 2).attr('y', 28)
  .attr('text-anchor', 'middle')
  .style('font-family', 'ABC Oracle, sans-serif')
  .style('font-size', '18px')
  .style('font-weight', '700')
  .style('fill', BLACK)
  .text('Where America\u2019s Technical PhDs Live');

svg.append('text')
  .attr('x', WIDTH / 2).attr('y', 50)
  .attr('text-anchor', 'middle')
  .style('font-family', 'ABC Oracle, sans-serif')
  .style('font-size', '11px')
  .style('font-weight', '300')
  .style('fill', '#888')
  .text('Each bubble is a metro. Size = total PhDs. Position = per-capita rate. Hover for details.');

// Source
svg.append('text')
  .attr('x', WIDTH - 10).attr('y', HEIGHT - 8)
  .attr('text-anchor', 'end')
  .style('font-family', 'ABC Oracle, sans-serif')
  .style('font-size', '9px')
  .style('font-weight', '300')
  .style('font-style', 'italic')
  .style('fill', '#aaa')
  .text('Source: ACS 5-Year (2019\u20132023) via IPUMS. CS, math, EE, physics doctoral holders.');

</script>
</body>
</html>
